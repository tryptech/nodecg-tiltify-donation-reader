<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<style>
		body {
			padding: 8px;
			margin: 0;
			height: 562px;
			display: flex;
			flex-direction: column;
			box-sizing: border-box;
		}
		.col-sm {
			flex-shrink: 0;
		}
		#donations {
			height: 515px;
			min-height: 0;
			overflow-y: auto;
			overflow-x: hidden;
		}
		/* Make scrollbar always visible */
		#donations::-webkit-scrollbar {
			width: 12px;
		}
		#donations::-webkit-scrollbar-track {
			background: #f1f1f1;
		}
		#donations::-webkit-scrollbar-thumb {
			background: #888;
			border-radius: 6px;
		}
		#donations::-webkit-scrollbar-thumb:hover {
			background: #555;
		}
		.monospace {
			font-family: monospace;
		}
		.card {
			box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
			transition: 0.3s;
			margin-bottom: 8px;
		}
		.container {
			padding: 2px 16px;
		}
		.teal,.hover-teal:hover{color:#fff!important;background-color:#009688!important}
		.btn,.button{border:none;display:inline-block;padding:8px 16px;vertical-align:middle;overflow:hidden;text-decoration:none;color:inherit;background-color:inherit;text-align:center;cursor:pointer;white-space:nowrap}
		.block {
			display: block;
			width: 100%;
		}
		.counter {
			padding: 8px 16px;
			text-align: center;
			font-weight: bold;
			font-size: 16px;
			background-color: #525F78;
			color: #fff;
		}
		.counter.flashing {
			animation: flash 1s infinite;
		}
		@keyframes flash {
			0%, 100% {
				opacity: 1;
				background-color: #525F78;
			}
			50% {
				opacity: 0.5;
				background-color: #009688;
			}
		}
		.no-unread-message {
			padding: 8px 16px;
			text-align: center;
			font-size: 14px;
			color: #666;
			background-color: #f5f5f5;
			border: 1px solid #ddd;
			border-radius: 4px;
			margin: 8px 0;
		}


	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
</head>
<body>
    <div class="col-sm">
		<div class="counter" id="unread-counter" style="display: none;">Unread Donations: 0</div>
		<div class="no-unread-message" id="no-unread-message" style="display: none;"></div>
		<p>
			<button class="btn teal block" id="clear-donations" href="#" role="button" style="display: none;">Clear Donation Queue</button> 
		</p>
    </div>
    <div class="col-sm-12" id="donations">
    </div>

	<script>
		var donations = [];
		var donationRep = nodecg.Replicant("donations", "nodecg-tiltify");
		var campaignTotalRep = nodecg.Replicant("total", "nodecg-tiltify");
		var campaignTotal = 0;
		var allDonationsRep = nodecg.Replicant("alldonations", "nodecg-tiltify");
		var donationsCount = 0;
		
		campaignTotalRep.on("change", function(newvalue) {
			if (newvalue && newvalue.value !== undefined) {
				campaignTotal = parseFloat(newvalue.value);
				updateNoUnreadMessage();
			}
		});

		allDonationsRep.on("change", function(newvalue) {
			if (newvalue && newvalue.length > 0) {
				donationsCount = newvalue.length;
				updateNoUnreadMessage();
			}
		});
		
		function updateNoUnreadMessage() {
			var unreadCount = 0;
			if (donations && donations.length > 0) {
				for (let i = 0; i < donations.length; i++) {
					if (!donations[i].read) {
						unreadCount++;
					}
				}
			}
			if (unreadCount === 0) {
				$("#no-unread-message").text("No unread donations.Total amount: $" + campaignTotal.toFixed(2) + " (" + donationsCount + ")").show();
			}
		}
		
		donationRep.on("change", function(newvalue, oldvalue) {
			donations = newvalue;
			$("#donations").empty();
			var unreadCount = 0;
			if (newvalue && newvalue.length > 0) {
				for (let i = 0; i < newvalue.length; i++) {
					if (newvalue[i].read) {
						continue;
					}
					unreadCount++;
					$("#donations").append("<div class=\"card\" id=\"donation-row-" + newvalue[i].id + "\"><div class=\"container\" style=\"border: rgb(82, 95, 120); border-radius: 12px; border-style: groove;\"><h2 id=\"name\"></h2><p id=\"message\"></p><p><button class=\"btn teal block\" id=\"button-" + newvalue[i].id + "\" href=\"#\" role=\"button\">Mark as read</button></p></div></div>");
					const row = $("#donation-row-" + newvalue[i].id);
					row.find("#name").text(`${newvalue[i].donor_name} Donated $${newvalue[i].amount.value}`);
					if (newvalue[i].donor_comment != undefined) {
						row.find("#message").text(newvalue[i].donor_comment);
					} else {
						row.find("#message").text("No Message");
					}
					row.find("#button-" + newvalue[i].id).click(function() {
						nodecg.sendMessageToBundle('set-donation-read', 'nodecg-tiltify', [newvalue[i], true]);
					});
				}
			}
			if (unreadCount > 0) {
				$("#unread-counter").text("Unread Donations: " + unreadCount).addClass("flashing").show();
				$("#no-unread-message").hide();
				$("#clear-donations").show();
			} else {
				$("#unread-counter").removeClass("flashing").hide();
				updateNoUnreadMessage();
				$("#clear-donations").hide();
			}
		});
		$("#clear-donations").click(function() {
		var confirmClear = confirm("Are you sure you want to clear all donations?")
		if (confirmClear == true) {
			nodecg.sendMessageToBundle('clear-donations', 'nodecg-tiltify');
		}
		});
	</script>
</body>
</html>
